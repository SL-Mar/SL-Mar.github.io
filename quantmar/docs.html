<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantMar Documentation - Technical Reference</title>
    <link rel="stylesheet" href="../assets/css/docs.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>
</head>
<body>

<!-- Header -->
<header class="docs-header">
    <div class="docs-header-content">
        <a href="docs.html" class="docs-logo">
            <i class="fas fa-chart-line"></i>
            <span>QuantMar</span>
        </a>
        <nav>
            <ul class="docs-nav">
                <li><a href="docs.html" class="active">Documentation</a></li>
                <li><a href="https://demo-quantmar.slmar.co" target="_blank"><i class="fas fa-external-link-alt"></i> Live Demo</a></li>
                <li><a href="https://github.com/SL-Mar/quantmar" target="_blank"><i class="fab fa-github"></i> GitHub</a></li>
            </ul>
        </nav>
        <a href="../index.html" class="back-to-main"><i class="fas fa-arrow-left"></i> Back to Main Site</a>
    </div>
</header>

<!-- Main Layout -->
<div class="docs-container">

    <!-- Sidebar -->
    <aside class="docs-sidebar">

        <div class="sidebar-section">
            <div class="sidebar-title">Getting Started</div>
            <ul class="sidebar-menu">
                <li><a href="#overview"><i class="fas fa-home"></i> Overview</a></li>
                <li><a href="#architecture"><i class="fas fa-sitemap"></i> Architecture</a></li>
                <li><a href="#installation"><i class="fas fa-download"></i> Installation</a></li>
                <li><a href="#tech-stack"><i class="fas fa-layer-group"></i> Tech Stack</a></li>
            </ul>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-title">Strategy SDK</div>
            <ul class="sidebar-menu">
                <li><a href="#strategy-base"><i class="fas fa-code"></i> Base Classes</a></li>
                <li><a href="#order-types"><i class="fas fa-shopping-cart"></i> Order Types</a></li>
                <li><a href="#portfolio-state"><i class="fas fa-wallet"></i> Portfolio State</a></li>
                <li><a href="#ast-validation"><i class="fas fa-shield-alt"></i> AST Validation</a></li>
            </ul>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-title">Backtest Engine</div>
            <ul class="sidebar-menu">
                <li><a href="#backtest-config"><i class="fas fa-cog"></i> Configuration</a></li>
                <li><a href="#backtest-metrics"><i class="fas fa-chart-bar"></i> Metrics</a></li>
                <li><a href="#walk-forward"><i class="fas fa-calendar-alt"></i> Walk-Forward</a></li>
                <li><a href="#fill-simulation"><i class="fas fa-check-circle"></i> Fill Simulation</a></li>
            </ul>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-title">Research</div>
            <ul class="sidebar-menu">
                <li><a href="#arxiv-search"><i class="fas fa-search"></i> ArXiv Search</a></li>
                <li><a href="#methodology-extraction"><i class="fas fa-brain"></i> Methodology Extraction</a></li>
                <li><a href="#code-generation"><i class="fas fa-code-branch"></i> Code Generation</a></li>
            </ul>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-title">Agent Tools</div>
            <ul class="sidebar-menu">
                <li><a href="#code-agent"><i class="fas fa-robot"></i> CodeAgent</a></li>
                <li><a href="#llm-router"><i class="fas fa-project-diagram"></i> LLM Router</a></li>
                <li><a href="#auto-mode"><i class="fas fa-magic"></i> Auto Mode</a></li>
            </ul>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-title">Live Trading</div>
            <ul class="sidebar-menu">
                <li><a href="#ib-integration"><i class="fas fa-link"></i> IB Integration</a></li>
                <li><a href="#live-state"><i class="fas fa-heartbeat"></i> Live State</a></li>
            </ul>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-title">API Reference</div>
            <ul class="sidebar-menu">
                <li><a href="#api-universes"><i class="fas fa-globe"></i> Universes</a></li>
                <li><a href="#api-research"><i class="fas fa-flask"></i> Research</a></li>
                <li><a href="#api-backtest"><i class="fas fa-vial"></i> Backtest</a></li>
                <li><a href="#api-strategies"><i class="fas fa-book"></i> Strategies</a></li>
            </ul>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-title">CLI Reference</div>
            <ul class="sidebar-menu">
                <li><a href="#cli-commands"><i class="fas fa-terminal"></i> Commands</a></li>
            </ul>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-title">Resources</div>
            <ul class="sidebar-menu">
                <li><a href="https://demo-quantmar.slmar.co" target="_blank"><i class="fas fa-external-link-alt"></i> Live Demo</a></li>
                <li><a href="https://github.com/SL-Mar/quantmar" target="_blank"><i class="fab fa-github"></i> GitHub</a></li>
            </ul>
        </div>

    </aside>

    <!-- Main Content -->
    <main class="docs-main">
        <div class="docs-content">

            <!-- ============================================================ -->
            <!-- OVERVIEW -->
            <!-- ============================================================ -->
            <section id="overview">
                <h1>QuantMar Technical Documentation</h1>
                <p class="docs-subtitle">AI-powered factor analysis platform for quantitative finance</p>

                <div class="alert" style="background: #f0f7f0; border-left: 4px solid #34a853; padding: 1rem 1.25rem; margin-bottom: 1.5rem;">
                    <strong><i class="fas fa-code-branch"></i> Development Log</strong>
                    <table style="width: 100%; margin-top: 0.75rem; font-size: 0.9rem; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid #d4e6d4;">
                            <td style="padding: 0.35rem 0; white-space: nowrap; color: #555; width: 7rem;"><strong>Session 3</strong></td>
                            <td style="padding: 0.35rem 0.5rem; color: #666; width: 6rem;">2026-02-14</td>
                            <td style="padding: 0.35rem 0;">Web UI + CI/CD + Demo Deployment (173 tests) — Research page (ArXiv search, methodology extraction, code gen), Backtest page (equity curve via lightweight-charts v5, 14 metrics), Strategies page (ranked list with code viewer), Dashboard, Settings, Chat, Docker images (API + frontend), GitHub Actions CI/CD, Hetzner deployment (demo-quantmar.slmar.co)</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #d4e6d4;">
                            <td style="padding: 0.35rem 0; white-space: nowrap; color: #555; width: 7rem;"><strong>Session 2</strong></td>
                            <td style="padding: 0.35rem 0.5rem; color: #666; width: 6rem;">2026-02-13</td>
                            <td style="padding: 0.35rem 0;">Agent Tools + Auto Mode + CLI (171 tests) — ArXiv integration with 429 retry, paper analyzer (methodology extraction + implementability scoring), strategy writer (generate + mutate), auto-session loop (fetch→code→backtest→mutate→test), Typer CLI (8 commands), IB client ABC + mock, `qf doctor` health checks</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.35rem 0; white-space: nowrap; color: #555;"><strong>Session 1</strong></td>
                            <td style="padding: 0.35rem 0.5rem; color: #666;">2026-02-12</td>
                            <td style="padding: 0.35rem 0;">Strategy SDK + Backtest Engine (83 tests) — Strategy base class (NaN sanitization), AST validation (import allowlist, no eval/exec/open), BacktestEngine (market/limit/stop/stop_limit fills), 14 metrics (Sharpe, Sortino, Calmar, alpha, beta, etc.), walk-forward split (60/17/23), database migration (delisted columns), survivorship bias patch</td>
                        </tr>
                    </table>
                </div>

                <div class="alert info">
                    <strong><i class="fas fa-info-circle"></i> Quantitative Finance Platform</strong><br>
                    QuantMar is an AI-powered factor analysis platform that converts academic research papers into executable
                    trading strategies. It combines ArXiv paper search, LLM-based methodology extraction, automated strategy code
                    generation, backtesting with realistic market simulation, and Interactive Brokers integration for live trading.
                    The platform uses a universe-based architecture where each stock universe (ETF constituents or sector screens)
                    has its own TimescaleDB database with OHLCV data and fundamentals from EODHD.
                </div>

                <h3>What is QuantMar?</h3>
                <p>
                    QuantMar is a full-stack quantitative finance platform designed to accelerate the research-to-production pipeline
                    for factor-based trading strategies. It automates the translation of academic research papers into Python code,
                    validates strategy logic using AST parsing (import allowlists, no dangerous builtins), backtests strategies
                    with a realistic fill simulation engine (market/limit/stop/stop_limit orders), and deploys to Interactive Brokers
                    for paper or live trading. The platform is built on a universe-centric architecture: users create stock universes
                    (e.g., "SPY constituents" or "Healthcare sector microcaps") via EODHD screening, and each universe gets its own
                    TimescaleDB database with OHLCV hypertables and fundamentals storage. Strategies operate within a single universe,
                    accessing data through a sandboxed execution environment that prevents file I/O and network access.
                </p>
                <p>
                    The research workflow begins with ArXiv paper search (title/abstract keywords, author filters, date ranges),
                    followed by LLM-based methodology extraction that parses the PDF and generates a structured summary of the
                    trading logic. The code generation step uses a two-stage process: first generating a draft strategy class,
                    then validating it against the Strategy SDK API and fixing compilation errors. Generated strategies are stored
                    in Redis (web UI) or on disk (CLI), ranked by backtest performance, and can be deployed to Interactive Brokers
                    via the `qf live deploy` command. The platform includes a CLI (`qf`) for headless operation, a web UI for
                    interactive development, and an "auto mode" that autonomously searches for papers, generates strategies,
                    backtests them, mutates top performers, and iterates until a performance threshold is reached.
                </p>

                <h3>Key Features</h3>
                <ul>
                    <li><strong>Research Integration</strong> — ArXiv search, PDF fetching, LLM methodology extraction</li>
                    <li><strong>Code Generation</strong> — Automated Strategy class generation from research methodologies</li>
                    <li><strong>Backtest Engine</strong> — Realistic fill simulation, 14 performance metrics, walk-forward validation</li>
                    <li><strong>Strategy SDK</strong> — Clean API for strategy development with NaN sanitization and AST validation</li>
                    <li><strong>Universe Management</strong> — ETF constituents or sector screens via EODHD, per-universe databases</li>
                    <li><strong>Live Trading</strong> — Interactive Brokers integration (paper/live via IB Gateway port 4001/7497)</li>
                    <li><strong>CLI Tool</strong> — `qf` command for setup, universe creation, backtesting, live deployment, auto mode</li>
                    <li><strong>Web UI</strong> — Research page, Backtest page, Strategies leaderboard, Universe workspace, Chat agent</li>
                    <li><strong>Security</strong> — AST import allowlist, sandboxed execution (Docker, no network/file access)</li>
                </ul>

            </section>

            <!-- ============================================================ -->
            <!-- ARCHITECTURE -->
            <!-- ============================================================ -->
            <section id="architecture">
                <h2>Architecture</h2>

                <h3>System Overview</h3>
                <p>
                    QuantMar is a three-tier application: a FastAPI backend (Python 3.12), a Next.js 14 frontend (TypeScript),
                    and a PostgreSQL + Redis data layer. The backend includes:
                </p>
                <ul>
                    <li><strong>Agents</strong> — CodeAgent for chat, LLM router (Ollama/Anthropic), tools (ArXiv, paper analyzer, strategy writer)</li>
                    <li><strong>Backtest</strong> — BacktestEngine, metrics calculator, walk-forward splitter</li>
                    <li><strong>Strategies</strong> — Strategy SDK (base classes, Order, PortfolioState), AST validator, sandbox runner</li>
                    <li><strong>Database</strong> — UniverseDBManager (one DB per universe), migrations, models (SQLAlchemy + TimescaleDB)</li>
                    <li><strong>Ingestion</strong> — EODHD client, OHLCV populator, fundamentals fetcher</li>
                    <li><strong>Live</strong> — IBClient ABC (Interactive Brokers wrapper), MockIBClient for testing</li>
                    <li><strong>Auto</strong> — Auto-mode session loop (fetch→code→backtest→mutate→test)</li>
                    <li><strong>CLI</strong> — Typer CLI (`qf` command) for headless operation</li>
                </ul>

                <h3>Data Flow</h3>
                <pre style="background: #f5f5f5; padding: 1rem; border-left: 4px solid #34a853; overflow-x: auto; font-size: 0.85rem;">
Research Paper → ArXiv Tool → PDF → Methodology Extraction (LLM) → Strategy Code (LLM + AST validation)
→ Backtest (OHLCV from TimescaleDB) → Metrics (Sharpe, Sortino, etc.) → Redis storage
→ Web UI (Strategies leaderboard) or CLI (qf strategy list)
→ Live deployment (qf live deploy → IB Gateway → Paper/Live trading)</pre>

                <h3>Database Schema</h3>
                <p>
                    The platform uses a multi-database architecture managed by PostgreSQL. A central <code>universe_registry</code>
                    database stores metadata for all universes (name, type, creation date, ticker count). Each universe gets its own
                    database (e.g., <code>universe_123</code>) with the following tables:
                </p>
                <ul>
                    <li><strong>universe_tickers</strong> — ticker, name, sector, delisted flag, delisted_date</li>
                    <li><strong>ohlcv</strong> — TimescaleDB hypertable partitioned by (ticker, granularity, timestamp), columns: open, high, low, close, volume</li>
                    <li><strong>fundamentals</strong> — JSON blob storage for per-ticker fundamentals (market cap, P/E, etc.)</li>
                </ul>
                <p>
                    TimescaleDB hypertables enable fast time-series queries for backtesting. The composite primary key
                    <code>(ticker, granularity, timestamp)</code> is required for hypertable partitioning.
                </p>

            </section>

            <!-- ============================================================ -->
            <!-- INSTALLATION -->
            <!-- ============================================================ -->
            <section id="installation">
                <h2>Installation</h2>

                <h3>Prerequisites</h3>
                <ul>
                    <li>Python 3.12+</li>
                    <li>Docker + Docker Compose</li>
                    <li>Node.js 20+ (for frontend development)</li>
                    <li>EODHD API key (free tier: 20 requests/day, $9.99/mo for 100k requests)</li>
                    <li>Ollama (for local LLM) or Anthropic API key (for cloud LLM)</li>
                </ul>

                <h3>CLI Installation</h3>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 1rem; border-radius: 4px; overflow-x: auto;">
<span style="color: #6272a4;"># Clone repository</span>
git clone https://github.com/SL-Mar/quantmar.git
cd quantmar

<span style="color: #6272a4;"># Install backend dependencies</span>
cd backend
pip install -r requirements.txt
pip install -e .

<span style="color: #6272a4;"># Start database and Redis</span>
docker compose up -d

<span style="color: #6272a4;"># Run setup wizard</span>
qf init

<span style="color: #6272a4;"># Verify installation</span>
qf doctor</pre>

                <h3>Web UI Development</h3>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 1rem; border-radius: 4px; overflow-x: auto;">
<span style="color: #6272a4;"># Start backend (port 8004)</span>
cd backend
uvicorn main:app --reload --host 0.0.0.0 --port 8004

<span style="color: #6272a4;"># Start frontend (port 3004)</span>
cd frontend
npm install
npm run dev</pre>

                <h3>Docker Deployment</h3>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 1rem; border-radius: 4px; overflow-x: auto;">
<span style="color: #6272a4;"># Production deployment</span>
docker compose -f docker-compose.demo.yml up -d

<span style="color: #6272a4;"># View logs</span>
docker logs qf-api -f</pre>

            </section>

            <!-- ============================================================ -->
            <!-- TECH STACK -->
            <!-- ============================================================ -->
            <section id="tech-stack">
                <h2>Tech Stack</h2>

                <h3>Backend</h3>
                <ul>
                    <li><strong>Framework</strong> — FastAPI (async, Pydantic validation)</li>
                    <li><strong>Database</strong> — TimescaleDB (PostgreSQL extension for time-series)</li>
                    <li><strong>Cache</strong> — Redis (backtest results, strategy registry)</li>
                    <li><strong>ORM</strong> — SQLAlchemy + asyncpg</li>
                    <li><strong>LLM</strong> — Ollama (qwen2.5-coder:14b local) + Anthropic Claude (cloud fallback)</li>
                    <li><strong>CLI</strong> — Typer + Rich (colored output, progress bars)</li>
                    <li><strong>Testing</strong> — pytest + pytest-asyncio (173 tests)</li>
                    <li><strong>Sandbox</strong> — Docker (code execution isolation)</li>
                    <li><strong>Broker</strong> — Interactive Brokers TWS API (ib_insync wrapper)</li>
                </ul>

                <h3>Frontend</h3>
                <ul>
                    <li><strong>Framework</strong> — Next.js 14 (App Router, TypeScript)</li>
                    <li><strong>Styling</strong> — Tailwind CSS</li>
                    <li><strong>State Management</strong> — Zustand</li>
                    <li><strong>Charts</strong> — lightweight-charts v5 (equity curves, candlestick charts)</li>
                    <li><strong>Code Editor</strong> — Monaco Editor (syntax highlighting for Python)</li>
                </ul>

                <h3>Data Sources</h3>
                <ul>
                    <li><strong>Market Data</strong> — EODHD (OHLCV, fundamentals, sector screening)</li>
                    <li><strong>Research</strong> — ArXiv API (academic papers search)</li>
                </ul>

            </section>

            <!-- ============================================================ -->
            <!-- STRATEGY SDK -->
            <!-- ============================================================ -->
            <section id="strategy-base">
                <h2>Strategy SDK</h2>

                <h3>Base Strategy Class</h3>
                <p>
                    All strategies inherit from <code>Strategy</code> and implement two methods: <code>initialize()</code>
                    (called once at start) and <code>on_data()</code> (called every bar). The base class provides:
                </p>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 1rem; border-radius: 4px; overflow-x: auto;">
<span style="color: #f92672;">class</span> <span style="color: #66d9ef;">Strategy</span>:
    <span style="color: #f92672;">def</span> <span style="color: #a6e22e;">initialize</span>(self, context: StrategyContext):
        <span style="color: #6272a4;"># Access universe data, set parameters</span>
        self.tickers = context.tickers
        self.start_date = context.start_date
        self.end_date = context.end_date

    <span style="color: #f92672;">def</span> <span style="color: #a6e22e;">on_data</span>(self, timestamp: datetime, data: pd.DataFrame, portfolio: PortfolioState):
        <span style="color: #6272a4;"># Trading logic: analyze data, create orders</span>
        <span style="color: #f92672;">for</span> ticker <span style="color: #f92672;">in</span> self.tickers:
            price = data.loc[ticker, <span style="color: #e6db74;">'close'</span>]
            <span style="color: #f92672;">if</span> self.should_buy(ticker, data):
                <span style="color: #f92672;">yield</span> Order.market_buy(ticker, <span style="color: #ae81ff;">100</span>)
            <span style="color: #f92672;">elif</span> self.should_sell(ticker, data):
                <span style="color: #f92672;">yield</span> Order.market_sell(ticker, <span style="color: #ae81ff;">100</span>)</pre>

            </section>

            <section id="order-types">
                <h3>Order Types</h3>
                <p>The platform supports four order types:</p>
                <ul>
                    <li><strong>Market</strong> — <code>Order.market_buy(ticker, qty)</code>, <code>Order.market_sell(ticker, qty)</code></li>
                    <li><strong>Limit</strong> — <code>Order.limit_buy(ticker, qty, limit_price)</code>, <code>Order.limit_sell(ticker, qty, limit_price)</code></li>
                    <li><strong>Stop</strong> — <code>Order.stop_buy(ticker, qty, stop_price)</code>, <code>Order.stop_sell(ticker, qty, stop_price)</code></li>
                    <li><strong>Stop-Limit</strong> — <code>Order.stop_limit_buy(ticker, qty, stop_price, limit_price)</code></li>
                </ul>
                <p>
                    Market orders fill at the open of the next bar. Limit orders fill if the next bar's high (for buys) or low (for sells)
                    crosses the limit price. Stop orders trigger if the next bar crosses the stop price. Stop-limit orders trigger at the
                    stop price and then fill like a limit order.
                </p>
            </section>

            <section id="portfolio-state">
                <h3>Portfolio State</h3>
                <p>
                    The <code>PortfolioState</code> object tracks cash, positions, and equity. It provides methods for position queries:
                </p>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 1rem; border-radius: 4px; overflow-x: auto;">
portfolio.cash         <span style="color: #6272a4;"># Available cash</span>
portfolio.equity       <span style="color: #6272a4;"># Total equity (cash + positions value)</span>
portfolio.positions    <span style="color: #6272a4;"># Dict[str, Position]</span>

position = portfolio.positions.get(<span style="color: #e6db74;">'AAPL'</span>)
position.qty           <span style="color: #6272a4;"># Number of shares</span>
position.avg_price     <span style="color: #6272a4;"># Average entry price</span>
position.market_value  <span style="color: #6272a4;"># Current position value</span></pre>
            </section>

            <section id="ast-validation">
                <h3>AST Validation</h3>
                <p>
                    All strategy code is validated using AST parsing before execution. The validator enforces:
                </p>
                <ul>
                    <li><strong>Import Allowlist</strong> — Only safe libraries (pandas, numpy, scipy, talib, sklearn, statsmodels)</li>
                    <li><strong>No Dangerous Builtins</strong> — Blocks eval(), exec(), open(), __import__, getattr()</li>
                    <li><strong>No File I/O</strong> — Blocks file operations, network access</li>
                    <li><strong>Required Structure</strong> — Must inherit from Strategy, implement initialize() and on_data()</li>
                </ul>
                <p>
                    Validation errors are returned as structured messages with line numbers, enabling the code generator to fix issues automatically.
                </p>
            </section>

            <!-- ============================================================ -->
            <!-- BACKTEST ENGINE -->
            <!-- ============================================================ -->
            <section id="backtest-config">
                <h2>Backtest Engine</h2>

                <h3>Configuration</h3>
                <p>Backtests are configured via <code>BacktestConfig</code>:</p>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 1rem; border-radius: 4px; overflow-x: auto;">
config = BacktestConfig(
    universe_id=<span style="color: #e6db74;">"universe_123"</span>,
    strategy_code=<span style="color: #e6db74;">"..."</span>,
    start_date=<span style="color: #e6db74;">"2023-01-01"</span>,
    end_date=<span style="color: #e6db74;">"2024-01-01"</span>,
    initial_cash=<span style="color: #ae81ff;">100000.0</span>,
    granularity=<span style="color: #e6db74;">"1d"</span>  <span style="color: #6272a4;"># or "1h", "5m", etc.</span>
)</pre>
            </section>

            <section id="backtest-metrics">
                <h3>Performance Metrics</h3>
                <p>The platform calculates 14 performance metrics:</p>
                <ul>
                    <li><strong>Total Return</strong> — (final_equity - initial_cash) / initial_cash</li>
                    <li><strong>CAGR</strong> — Annualized return</li>
                    <li><strong>Sharpe Ratio</strong> — Risk-adjusted return (assumes 0% risk-free rate)</li>
                    <li><strong>Sortino Ratio</strong> — Downside risk-adjusted return</li>
                    <li><strong>Calmar Ratio</strong> — Return / max drawdown</li>
                    <li><strong>Max Drawdown</strong> — Peak-to-trough decline</li>
                    <li><strong>Volatility</strong> — Annualized standard deviation of returns</li>
                    <li><strong>Win Rate</strong> — Percentage of profitable trades</li>
                    <li><strong>Profit Factor</strong> — Gross profit / gross loss</li>
                    <li><strong>Alpha</strong> — Excess return vs. benchmark (SPY)</li>
                    <li><strong>Beta</strong> — Correlation to benchmark</li>
                    <li><strong>Total Trades</strong> — Number of completed trades</li>
                    <li><strong>Avg Trade Duration</strong> — Average holding period (days)</li>
                    <li><strong>Avg Win/Loss</strong> — Average profit/loss per trade</li>
                </ul>
            </section>

            <section id="walk-forward">
                <h3>Walk-Forward Validation</h3>
                <p>
                    The walk-forward splitter divides the backtest period into train/validate/test sets (60%/17%/23% by default).
                    This prevents overfitting by testing on out-of-sample data. The splitter respects minimum period requirements
                    (90 days for training, 30 days for validation/test).
                </p>
            </section>

            <section id="fill-simulation">
                <h3>Fill Simulation</h3>
                <p>
                    The backtest engine uses realistic fill logic:
                </p>
                <ul>
                    <li><strong>Market orders</strong> — Fill at next bar's open</li>
                    <li><strong>Limit orders</strong> — Fill if next bar crosses limit price (high for buys, low for sells)</li>
                    <li><strong>Stop orders</strong> — Trigger if next bar crosses stop price, then fill at trigger price</li>
                    <li><strong>Stop-limit orders</strong> — Trigger at stop, fill at limit if next bar crosses limit</li>
                </ul>
                <p>
                    No slippage or commission modeling (future enhancement). Partial fills are not supported (all-or-nothing).
                </p>
            </section>

            <!-- ============================================================ -->
            <!-- RESEARCH -->
            <!-- ============================================================ -->
            <section id="arxiv-search">
                <h2>Research</h2>

                <h3>ArXiv Search</h3>
                <p>
                    The ArXiv tool searches academic papers by title, abstract, author, and category. It supports:
                </p>
                <ul>
                    <li><strong>Keyword search</strong> — <code>q="momentum factor"</code></li>
                    <li><strong>Author filter</strong> — <code>author="Fama"</code></li>
                    <li><strong>Date range</strong> — <code>start_date="2020-01-01"</code></li>
                    <li><strong>Category filter</strong> — <code>cat="q-fin"</code> (quantitative finance)</li>
                </ul>
                <p>
                    The tool fetches paper metadata (title, authors, abstract, PDF URL, publish date) and returns up to
                    <code>max_results</code> papers (default 50). Results are sorted by relevance.
                </p>
            </section>

            <section id="methodology-extraction">
                <h3>Methodology Extraction</h3>
                <p>
                    The paper analyzer uses an LLM to extract trading methodology from research papers. It:
                </p>
                <ol>
                    <li>Fetches the PDF from ArXiv</li>
                    <li>Extracts text (pypdf fallback if needed)</li>
                    <li>Sends text to LLM with a structured prompt</li>
                    <li>Parses LLM response into a Methodology object (entry rules, exit rules, indicators, parameters)</li>
                    <li>Scores implementability (0-10) based on data requirements and complexity</li>
                </ol>
                <p>
                    The methodology is stored as a structured JSON object, enabling the code generator to produce faithful implementations.
                </p>
            </section>

            <section id="code-generation">
                <h3>Code Generation</h3>
                <p>
                    The strategy writer generates Strategy class code from a methodology. It uses a two-stage process:
                </p>
                <ol>
                    <li><strong>Draft generation</strong> — LLM generates Python code following the Strategy SDK API</li>
                    <li><strong>AST validation</strong> — Code is validated against import allowlist and required structure</li>
                    <li><strong>Fix loop</strong> — If validation fails, LLM receives error messages and generates a fix (max 3 retries)</li>
                </ol>
                <p>
                    The generator includes example code in the prompt to guide the LLM toward correct API usage. It also injects
                    typing and dataclass imports to handle common import errors.
                </p>
            </section>

            <!-- ============================================================ -->
            <!-- AGENT TOOLS -->
            <!-- ============================================================ -->
            <section id="code-agent">
                <h2>Agent Tools</h2>

                <h3>CodeAgent</h3>
                <p>
                    The CodeAgent is a chat-based interface for strategy development. Users ask questions like "create a momentum
                    strategy" or "backtest this code", and the agent uses tools to fetch data, generate code, run backtests, and
                    return results. It maintains conversation context in Redis (5-minute TTL per session).
                </p>
            </section>

            <section id="llm-router">
                <h3>LLM Router</h3>
                <p>
                    The LLM router abstracts provider differences (Ollama vs. Anthropic). It tries Ollama first (local inference),
                    then falls back to Anthropic if Ollama is unavailable. Configuration is stored in Redis and can be updated via
                    the Settings API. The router supports:
                </p>
                <ul>
                    <li><strong>Provider selection</strong> — "ollama" or "anthropic"</li>
                    <li><strong>Model selection</strong> — e.g., "qwen2.5-coder:14b" (Ollama) or "claude-3-5-sonnet-20241022" (Anthropic)</li>
                    <li><strong>Temperature</strong> — 0.0 (deterministic) to 1.0 (creative)</li>
                    <li><strong>Max tokens</strong> — Response length limit</li>
                    <li><strong>Context window</strong> — <code>num_ctx</code> parameter for Ollama (default 2048)</li>
                </ul>
            </section>

            <section id="auto-mode">
                <h3>Auto Mode</h3>
                <p>
                    Auto mode is a fully autonomous research loop that runs until a performance target is reached. The loop:
                </p>
                <ol>
                    <li><strong>Fetch papers</strong> — Search ArXiv for quantitative finance papers</li>
                    <li><strong>Extract methodology</strong> — Use LLM to parse trading logic</li>
                    <li><strong>Generate code</strong> — Create Strategy class</li>
                    <li><strong>Backtest</strong> — Run on historical data</li>
                    <li><strong>Evaluate</strong> — Check if Sharpe ratio exceeds target</li>
                    <li><strong>Mutate</strong> — If target not reached, mutate parameters and retry (max iterations)</li>
                </ol>
                <p>
                    Auto mode saves all strategies to disk (<code>~/.quantfundamentals/strategies/</code>) and logs progress to console.
                </p>
            </section>

            <!-- ============================================================ -->
            <!-- LIVE TRADING -->
            <!-- ============================================================ -->
            <section id="ib-integration">
                <h2>Live Trading</h2>

                <h3>Interactive Brokers Integration</h3>
                <p>
                    The platform connects to IB Gateway or TWS via the <code>ib_insync</code> library. It supports:
                </p>
                <ul>
                    <li><strong>Paper trading</strong> — Port 7497 (IB Gateway paper account)</li>
                    <li><strong>Live trading</strong> — Port 4001 (IB Gateway live account)</li>
                </ul>
                <p>
                    The <code>IBClient</code> abstract base class defines methods for connecting, fetching portfolio, submitting orders,
                    and monitoring fills. A <code>MockIBClient</code> is provided for testing without IB Gateway.
                </p>
            </section>

            <section id="live-state">
                <h3>Live State</h3>
                <p>
                    Live trading state is stored in a <code>LiveState</code> object:
                </p>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 1rem; border-radius: 4px; overflow-x: auto;">
state = LiveState(
    strategy_name=<span style="color: #e6db74;">"momentum_v1"</span>,
    universe_id=<span style="color: #e6db74;">"universe_123"</span>,
    started_at=datetime.now(),
    portfolio=PortfolioState(...),
    fills=[],  <span style="color: #6272a4;"># List of FillRecord</span>
    errors=[]  <span style="color: #6272a4;"># List of error messages</span>
)</pre>
                <p>
                    The <code>qf live status</code> command displays current positions, pending orders, and recent fills.
                </p>
            </section>

            <!-- ============================================================ -->
            <!-- API REFERENCE -->
            <!-- ============================================================ -->
            <section id="api-universes">
                <h2>API Reference</h2>

                <h3>Universes</h3>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 1rem; border-radius: 4px; overflow-x: auto;">
<span style="color: #66d9ef;">GET</span>    /api/universes                    <span style="color: #6272a4;"># List all universes</span>
<span style="color: #66d9ef;">POST</span>   /api/universes                    <span style="color: #6272a4;"># Create universe (ETF or sector)</span>
<span style="color: #66d9ef;">GET</span>    /api/universes/{id}               <span style="color: #6272a4;"># Get universe details</span>
<span style="color: #66d9ef;">DELETE</span> /api/universes/{id}               <span style="color: #6272a4;"># Delete universe</span>
<span style="color: #66d9ef;">POST</span>   /api/universes/{id}/refresh       <span style="color: #6272a4;"># Refresh OHLCV data</span>
<span style="color: #66d9ef;">GET</span>    /api/universes/{id}/progress      <span style="color: #6272a4;"># Get creation progress</span>
<span style="color: #66d9ef;">GET</span>    /api/universes/{id}/data/ohlcv    <span style="color: #6272a4;"># Get OHLCV data</span>
<span style="color: #66d9ef;">GET</span>    /api/universes/{id}/data/fundamentals  <span style="color: #6272a4;"># Get fundamentals</span>
<span style="color: #66d9ef;">GET</span>    /api/universes/{id}/data/tickers  <span style="color: #6272a4;"># Get ticker list</span></pre>
            </section>

            <section id="api-research">
                <h3>Research</h3>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 1rem; border-radius: 4px; overflow-x: auto;">
<span style="color: #66d9ef;">GET</span>  /api/research/papers?q=&max_results=  <span style="color: #6272a4;"># Search ArXiv papers</span>
<span style="color: #66d9ef;">POST</span> /api/research/analyze                 <span style="color: #6272a4;"># Extract methodology (async, returns task_id)</span>
<span style="color: #66d9ef;">POST</span> /api/research/generate                <span style="color: #6272a4;"># Generate strategy code (async, returns task_id)</span>
<span style="color: #66d9ef;">GET</span>  /api/research/task/{task_id}          <span style="color: #6272a4;"># Poll task status</span></pre>
            </section>

            <section id="api-backtest">
                <h3>Backtest</h3>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 1rem; border-radius: 4px; overflow-x: auto;">
<span style="color: #66d9ef;">POST</span> /api/backtest/run  <span style="color: #6272a4;"># Start backtest (async, returns backtest_id)</span>
<span style="color: #66d9ef;">GET</span>  /api/backtest/{id} <span style="color: #6272a4;"># Get backtest result (poll for completion)</span></pre>
            </section>

            <section id="api-strategies">
                <h3>Strategies</h3>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 1rem; border-radius: 4px; overflow-x: auto;">
<span style="color: #66d9ef;">GET</span>    /api/strategies?sort_by=  <span style="color: #6272a4;"># List strategies (sorted by sharpe/return/calmar)</span>
<span style="color: #66d9ef;">GET</span>    /api/strategies/{name}    <span style="color: #6272a4;"># Get specific strategy</span>
<span style="color: #66d9ef;">POST</span>   /api/strategies           <span style="color: #6272a4;"># Save strategy (with AST validation)</span>
<span style="color: #66d9ef;">DELETE</span> /api/strategies/{name}    <span style="color: #6272a4;"># Delete strategy</span></pre>
            </section>

            <!-- ============================================================ -->
            <!-- CLI REFERENCE -->
            <!-- ============================================================ -->
            <section id="cli-commands">
                <h2>CLI Reference</h2>

                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 1rem; border-radius: 4px; overflow-x: auto;">
<span style="color: #6272a4;"># Setup and diagnostics</span>
qf init                              <span style="color: #6272a4;"># Run setup wizard (API keys, LLM config)</span>
qf doctor                            <span style="color: #6272a4;"># Run health checks (DB, Redis, Ollama, EODHD)</span>

<span style="color: #6272a4;"># Universe management</span>
qf universe create-etf SPY           <span style="color: #6272a4;"># Create universe from ETF</span>
qf universe create-sector Healthcare <span style="color: #6272a4;"># Create universe from sector</span>
qf universe list                     <span style="color: #6272a4;"># List all universes</span>
qf universe delete universe_123      <span style="color: #6272a4;"># Delete universe</span>

<span style="color: #6272a4;"># Chat and research</span>
qf chat universe_123                 <span style="color: #6272a4;"># Interactive chat for strategy development</span>

<span style="color: #6272a4;"># Auto mode</span>
qf auto --universe-id=universe_123 --target-sharpe=1.5 --max-iterations=10

<span style="color: #6272a4;"># Backtesting</span>
qf backtest --universe-id=universe_123 --strategy-file=my_strategy.py --start-date=2023-01-01 --end-date=2024-01-01

<span style="color: #6272a4;"># Strategy management</span>
qf strategy list                     <span style="color: #6272a4;"># List saved strategies</span>
qf strategy show momentum_v1         <span style="color: #6272a4;"># Show strategy code</span>

<span style="color: #6272a4;"># Live trading</span>
qf live deploy momentum_v1 --universe-id=universe_123 --mode=paper
qf live status                       <span style="color: #6272a4;"># Show current positions and orders</span>
qf live stop                         <span style="color: #6272a4;"># Stop live trading</span>

<span style="color: #6272a4;"># Web UI</span>
qf web                               <span style="color: #6272a4;"># Start web server (FastAPI backend + Next.js frontend)</span></pre>

            </section>

        </div>
    </main>

</div>

<!-- Footer -->
<footer style="background: #1a1a1a; color: #ccc; padding: 2rem 0; margin-top: 4rem; text-align: center; font-size: 0.9rem;">
    <p>QuantMar &copy; 2026 | Apache 2.0 License | <a href="https://github.com/SL-Mar/quantmar" target="_blank" style="color: #66d9ef; text-decoration: none;">GitHub</a> | <a href="https://demo-quantmar.slmar.co" target="_blank" style="color: #66d9ef; text-decoration: none;">Live Demo</a></p>
</footer>

<script>
// Smooth scroll for anchor links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    });
});

// Render KaTeX math (if any formulas are added later)
if (window.renderMathInElement) {
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
            ]
        });
    });
}
</script>

</body>
</html>
